{"version":3,"file":"scope.js","sourceRoot":"","sources":["../src/scope.ts"],"names":[],"mappings":"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","sourcesContent":["import { Breadcrumb, SentryEvent, SentryEventHint, Severity, User } from '@sentry/types';\nimport { getGlobalObject } from '@sentry/utils/misc';\nimport { assign } from '@sentry/utils/object';\n\nexport type EventProcessor = (event: SentryEvent, hint?: SentryEventHint) => Promise<SentryEvent | null>;\n\n/**\n * Holds additional event information. {@link Scope.applyToEvent} will be\n * called by the client before an event will be sent.\n */\nexport class Scope {\n  /** Flag if notifiying is happening. */\n  protected notifyingListeners: boolean = false;\n\n  /** Callback for client to receive scope changes. */\n  protected scopeListeners: Array<(scope: Scope) => void> = [];\n\n  /** Callback list that will be called after {@link applyToEvent}. */\n  protected eventProcessors: EventProcessor[] = [];\n\n  /** Array of breadcrumbs. */\n  protected breadcrumbs: Breadcrumb[] = [];\n\n  /** User */\n  protected user: User = {};\n\n  /** Tags */\n  protected tags: { [key: string]: string } = {};\n\n  /** Extra */\n  protected extra: { [key: string]: any } = {};\n\n  /** Fingerprint */\n  protected fingerprint?: string[];\n\n  /** Severity */\n  protected level?: Severity;\n\n  /** Add internal on change listener. */\n  public addScopeListener(callback: (scope: Scope) => void): void {\n    this.scopeListeners.push(callback);\n  }\n\n  /** Add new event processor that will be called after {@link applyToEvent}. */\n  public addEventProcessor(callback: EventProcessor): Scope {\n    this.eventProcessors.push(callback);\n    return this;\n  }\n\n  /**\n   * This will be called on every set call.\n   */\n  protected notifyScopeListeners(): void {\n    if (!this.notifyingListeners) {\n      this.notifyingListeners = true;\n      setTimeout(() => {\n        this.scopeListeners.forEach(callback => {\n          callback(this);\n        });\n        this.notifyingListeners = false;\n      }, 0);\n    }\n  }\n\n  /**\n   * This will be called after {@link applyToEvent} is finished.\n   */\n  protected async notifyEventProcessors(event: SentryEvent, hint?: SentryEventHint): Promise<SentryEvent | null> {\n    let processedEvent: SentryEvent | null = event;\n    for (const processor of [...getGlobalEventProcessors(), ...this.eventProcessors]) {\n      try {\n        processedEvent = await processor({ ...processedEvent }, hint);\n        if (processedEvent === null) {\n          return null;\n        }\n      } catch (e) {\n        continue;\n      }\n    }\n    return processedEvent;\n  }\n\n  /**\n   * Updates user context information for future events.\n   * @param user User context object to merge into current context.\n   */\n  public setUser(user: User): Scope {\n    this.user = user;\n    this.notifyScopeListeners();\n    return this;\n  }\n\n  /**\n   * Updates tags context information for future events.\n   * @param tags Tags context object to merge into current context.\n   */\n  public setTag(key: string, value: string): Scope {\n    this.tags = { ...this.tags, [key]: value };\n    this.notifyScopeListeners();\n    return this;\n  }\n\n  /**\n   * Updates extra context information for future events.\n   * @param extra context object to merge into current context.\n   */\n  public setExtra(key: string, extra: any): Scope {\n    this.extra = { ...this.extra, [key]: extra };\n    this.notifyScopeListeners();\n    return this;\n  }\n\n  /**\n   * Sets the fingerprint on the scope to send with the events.\n   * @param fingerprint string[] to group events in Sentry.\n   */\n  public setFingerprint(fingerprint: string[]): Scope {\n    this.fingerprint = fingerprint;\n    this.notifyScopeListeners();\n    return this;\n  }\n\n  /**\n   * Sets the level on the scope for future events.\n   * @param level string {@link Severity}\n   */\n  public setLevel(level: Severity): Scope {\n    this.level = level;\n    this.notifyScopeListeners();\n    return this;\n  }\n\n  /**\n   * Inherit values from the parent scope.\n   * @param scope to clone.\n   */\n  public static clone(scope?: Scope): Scope {\n    const newScope = new Scope();\n    assign(newScope, scope, {\n      scopeListeners: [],\n    });\n    if (scope) {\n      newScope.extra = assign(scope.extra);\n      newScope.tags = assign(scope.tags) as any;\n      newScope.breadcrumbs = [...scope.breadcrumbs];\n      newScope.eventProcessors = [...scope.eventProcessors];\n    }\n    return newScope;\n  }\n\n  /** Clears the current scope and resets its properties. */\n  public clear(): void {\n    this.breadcrumbs = [];\n    this.tags = {};\n    this.extra = {};\n    this.user = {};\n    this.level = undefined;\n    this.fingerprint = undefined;\n    this.notifyScopeListeners();\n  }\n\n  /**\n   * Sets the breadcrumbs in the scope\n   * @param breadcrumbs Breadcrumb\n   * @param maxBreadcrumbs number of max breadcrumbs to merged into event.\n   */\n  public addBreadcrumb(breadcrumb: Breadcrumb, maxBreadcrumbs?: number): void {\n    this.breadcrumbs =\n      maxBreadcrumbs !== undefined && maxBreadcrumbs >= 0\n        ? [...this.breadcrumbs, breadcrumb].slice(-maxBreadcrumbs)\n        : [...this.breadcrumbs, breadcrumb];\n    this.notifyScopeListeners();\n  }\n\n  /**\n   * Applies fingerprint from the scope to the event if there's one,\n   * uses message if there's one instead or get rid of empty fingerprint\n   */\n  private applyFingerprint(event: SentryEvent): void {\n    // Make sure it's an array first and we actually have something in place\n    event.fingerprint = event.fingerprint\n      ? Array.isArray(event.fingerprint)\n        ? event.fingerprint\n        : [event.fingerprint]\n      : [];\n\n    // If we have something on the scope, then merge it with event\n    if (this.fingerprint) {\n      event.fingerprint = event.fingerprint.concat(this.fingerprint);\n    } else if (event.message) {\n      // If not, but we have message, use it instead\n      event.fingerprint = event.fingerprint.concat(event.message);\n    }\n\n    // If we have no data at all, remove empty array default\n    if (event.fingerprint && !event.fingerprint.length) {\n      delete event.fingerprint;\n    }\n  }\n\n  /**\n   * Applies the current context and fingerprint to the event.\n   * Note that breadcrumbs will be added by the client.\n   * Also if the event has already breadcrumbs on it, we do not merge them.\n   * @param event SentryEvent\n   * @param hint May contain additional informartion about the original exception.\n   * @param maxBreadcrumbs number of max breadcrumbs to merged into event.\n   */\n  public async applyToEvent(\n    event: SentryEvent,\n    hint?: SentryEventHint,\n    maxBreadcrumbs?: number,\n  ): Promise<SentryEvent | null> {\n    if (this.extra && Object.keys(this.extra).length) {\n      event.extra = { ...this.extra, ...event.extra };\n    }\n    if (this.tags && Object.keys(this.tags).length) {\n      event.tags = { ...this.tags, ...event.tags };\n    }\n    if (this.user && Object.keys(this.user).length) {\n      event.user = { ...this.user, ...event.user };\n    }\n    if (this.level) {\n      event.level = this.level;\n    }\n\n    this.applyFingerprint(event);\n\n    const hasNoBreadcrumbs = !event.breadcrumbs || event.breadcrumbs.length === 0;\n    if (hasNoBreadcrumbs && this.breadcrumbs.length > 0) {\n      event.breadcrumbs =\n        maxBreadcrumbs !== undefined && maxBreadcrumbs >= 0\n          ? this.breadcrumbs.slice(-maxBreadcrumbs)\n          : this.breadcrumbs;\n    }\n\n    return this.notifyEventProcessors(event, hint);\n  }\n}\n\n/**\n * Retruns the global event processors.\n */\nfunction getGlobalEventProcessors(): EventProcessor[] {\n  const global: any = getGlobalObject();\n  global.__SENTRY__ = global.__SENTRY__ || {};\n  global.__SENTRY__.globalEventProcessors = global.__SENTRY__.globalEventProcessors || [];\n  return global.__SENTRY__.globalEventProcessors;\n}\n\n/**\n * Add a EventProcessor to be kept globally.\n * @param callback EventProcessor to add\n */\nexport function addGlobalEventProcessor(callback: EventProcessor): void {\n  getGlobalEventProcessors().push(callback);\n}\n"]}