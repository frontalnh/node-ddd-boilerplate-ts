var nodemailer  = require('nodemailer');
var sgTransport = require('../src/sendgrid-transport.js');
var officegen   = require('officegen');
var fs          = require('fs');
var S           = require('stream');
var path        = require('path');
var docx        = officegen ( 'docx' );

docx.on ( 'finalize', function ( written ) {
      console.log ( 'Finish to create Word file.\nTotal bytes created: ' + written + '\n' );
    });
docx.on ( 'error', function ( err ) {
      console.log ( err );
    });

var pObj = docx.createP();
pObj.addText('Simple');

var stream = new S.Duplex;
stream.on('error', function(err) {
  console.log(err);
});

var options = {
    auth: {
        api_user: process.env['SENDGRID_USERNAME'],
        api_key: process.env['SENDGRID_PASSWORD']
    }
}

var mailer = nodemailer.createTransport(sgTransport(options));

docx.generate(stream, {
 'finalize': function(written) {
   console.log('hi');
    var email = {
        to: ['eddiezane@sendgrid.com'],
        from: 'taco@cat.limo',
        subject: 'Hi there',
        text: 'Awesome sauce',
        html: '<b>Awesome sauce</b>',
        attachments: [
          {
            filename: 'test.txt',
            content: stream
          }
        ]
    };

    mailer.sendMail(email, function(err, res) {
        if (err) { 
            console.log(err) 
        }
        console.log(res);
    });
 },
'error': function ( err ) {
           console.log ( err );
              } 
});



