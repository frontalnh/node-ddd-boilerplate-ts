{"version":3,"sources":["../../src/metadata/MetadataStorage.ts"],"names":[],"mappings":"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","file":"MetadataStorage.js","sourcesContent":["import {ValidationMetadata} from \"./ValidationMetadata\";\r\nimport {ConstraintMetadata} from \"./ConstraintMetadata\";\r\nimport {ValidationSchema} from \"../validation-schema/ValidationSchema\";\r\nimport {ValidationSchemaToMetadataTransformer} from \"../validation-schema/ValidationSchemaToMetadataTransformer\";\r\n\r\n/**\r\n * Storage all metadatas.\r\n */\r\nexport class MetadataStorage {\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Private properties\r\n    // -------------------------------------------------------------------------\r\n\r\n    private validationMetadatas: ValidationMetadata[] = [];\r\n    private constraintMetadatas: ConstraintMetadata[] = [];\r\n\r\n    get hasValidationMetaData() {\r\n        return !!this.validationMetadatas.length;\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Public Methods\r\n    // -------------------------------------------------------------------------\r\n\r\n    /**\r\n     * Adds a new validation metadata.\r\n     */\r\n    addValidationSchema(schema: ValidationSchema) {\r\n        const validationMetadatas = new ValidationSchemaToMetadataTransformer().transform(schema);\r\n        validationMetadatas.forEach(validationMetadata => this.addValidationMetadata(validationMetadata));\r\n    }\r\n    \r\n    /**\r\n     * Adds a new validation metadata.\r\n     */\r\n    addValidationMetadata(metadata: ValidationMetadata) {\r\n        this.validationMetadatas.push(metadata);\r\n    }\r\n\r\n    /**\r\n     * Adds a new constraint metadata.\r\n     */\r\n    addConstraintMetadata(metadata: ConstraintMetadata) {\r\n        this.constraintMetadatas.push(metadata);\r\n    }\r\n\r\n    /**\r\n     * Groups metadata by their property names.\r\n     */\r\n    groupByPropertyName(metadata: ValidationMetadata[]): { [propertyName: string]: ValidationMetadata[] } {\r\n        const grouped: { [propertyName: string]: ValidationMetadata[] } = {};\r\n        metadata.forEach(metadata => {\r\n            if (!grouped[metadata.propertyName])\r\n                grouped[metadata.propertyName] = [];\r\n            grouped[metadata.propertyName].push(metadata);\r\n        });\r\n        return grouped;\r\n    }\r\n\r\n    /**\r\n     * Gets all validation metadatas for the given object with the given groups.\r\n     */\r\n    getTargetValidationMetadatas(targetConstructor: Function, targetSchema: string, groups?: string[]): ValidationMetadata[] {\r\n        \r\n        // get directly related to a target metadatas\r\n        const originalMetadatas = this.validationMetadatas.filter(metadata => {\r\n            if (metadata.target !== targetConstructor && metadata.target !== targetSchema)\r\n                return false;\r\n            if (metadata.always) \r\n                return true;\r\n            if (groups && groups.length > 0)\r\n                return metadata.groups && !!metadata.groups.find(group => groups.indexOf(group) !== -1);\r\n            \r\n            return true;\r\n        });\r\n        \r\n        // get metadatas for inherited classes\r\n        const inheritedMetadatas = this.validationMetadatas.filter(metadata => {\r\n            // if target is a string it's means we validate agains a schema, and there is no inheritance support for schemas\r\n            if (typeof metadata.target === \"string\")\r\n                return false;\r\n            if (metadata.target === targetConstructor)\r\n                return false;\r\n            if (metadata.target instanceof Function &&\r\n                !(targetConstructor.prototype instanceof (metadata.target as Function)))\r\n                return false;\r\n            if (metadata.always) \r\n                return true;\r\n            if (groups && groups.length > 0)\r\n                return metadata.groups && !!metadata.groups.find(group => groups.indexOf(group) !== -1);\r\n            \r\n            return true;\r\n        });\r\n\r\n        // filter out duplicate metadatas, prefer original metadatas instead of inherited metadatas\r\n        const uniqueInheritedMetadatas = inheritedMetadatas.filter(inheritedMetadata => {\r\n            return !originalMetadatas.find(originalMetadata => {\r\n                return  originalMetadata.propertyName === inheritedMetadata.propertyName && \r\n                        originalMetadata.type === inheritedMetadata.type;\r\n            });\r\n        });\r\n\r\n        return originalMetadatas.concat(uniqueInheritedMetadatas);\r\n    }\r\n\r\n    /**\r\n     * Gets all validator constraints for the given object.\r\n     */\r\n    getTargetValidatorConstraints(target: Function): ConstraintMetadata[] {\r\n        return this.constraintMetadatas.filter(metadata => metadata.target === target);\r\n    }\r\n\r\n}"],"sourceRoot":".."}